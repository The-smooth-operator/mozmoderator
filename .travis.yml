language: python
dist: xenial
addons:
  snaps:
  - name: aws-cli
    confinement: classic
    channel: latest/edge
services:
- docker
before_install:
- pip install flake8
- npm install -g eslint stylelint
script:
- flake8 moderator
- eslint 'moderator/moderate/static/js/*.js'
- stylelint 'moderator/moderate/static/css/*.css'
- docker build . -t "$ECR:$TRAVIS_COMMIT"
before_deploy:
- eval $(aws ecr get-login --no-include-email --region us-west-2)
deploy:
  provider: script
  on:
    all_branches: true
    condition: "$TRAVIS_BRANCH =~ ^(master|prod)$"
  script: docker push "$ECR:$TRAVIS_COMMIT"
env:
  global:
  - secure: "V8Yo2wTOgf3c4DZoIc2w6Y1NaSUlTpx+RA/XKd66uAGc0HaZ3mcPykCq5YkSfq5z4ONdaUEGPM4hTH7Wf0CnJVANkEXl4dzwkMH3DFsrif2iClLUBuu3/c/gMrGuNi/251RqHWl4DVxSX3pm04iGrtIZzeTByfIAqoV9NmEGRuo="
  - ECR="$AWS_ACCOUNT_ID.dkr.ecr.us-west-2.amazonaws.com/moderator"
